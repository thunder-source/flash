     1                                  ; ============================================================================
     2                                  ; Flash Compiler - IR Generator
     3                                  ; ============================================================================
     4                                  ; Converts AST to Three-Address Code IR
     5                                  ; ============================================================================
     6                                  
     7                                  bits 64
     8                                  default rel
     9                                  
    10                                  ; External IR functions
    11                                  extern ir_program_create
    12                                  extern ir_function_create
    13                                  extern ir_instruction_create
    14                                  extern ir_operand_temp
    15                                  extern ir_operand_var
    16                                  extern ir_operand_const
    17                                  extern ir_operand_label
    18                                  extern ir_emit
    19                                  extern ir_emit_binary
    20                                  extern ir_emit_move
    21                                  extern ir_emit_return
    22                                  extern ir_new_temp
    23                                  extern ir_new_label
    24                                  extern arena_alloc
    25                                  
    26                                  ; Include AST node type definitions
    27                                  %define AST_PROGRAM         0
    28                                  %define AST_FUNCTION        1
    29                                  %define AST_BLOCK           20
    30                                  %define AST_LET_STMT        21
    31                                  %define AST_ASSIGN_STMT     22
    32                                  %define AST_IF_STMT         23
    33                                  %define AST_WHILE_STMT      24
    34                                  %define AST_FOR_STMT        25
    35                                  %define AST_RETURN_STMT     26
    36                                  %define AST_BREAK_STMT      27
    37                                  %define AST_CONTINUE_STMT   28
    38                                  %define AST_EXPR_STMT       29
    39                                  %define AST_BINARY_EXPR     50
    40                                  %define AST_UNARY_EXPR      51
    41                                  %define AST_LITERAL_EXPR    52
    42                                  %define AST_IDENTIFIER      53
    43                                  %define AST_CALL_EXPR       54
    44                                  
    45                                  ; IR opcodes
    46                                  %define IR_ADD          0
    47                                  %define IR_SUB          1
    48                                  %define IR_MUL          2
    49                                  %define IR_DIV          3
    50                                  %define IR_MOD          4
    51                                  %define IR_NEG          5
    52                                  %define IR_AND          20
    53                                  %define IR_OR           21
    54                                  %define IR_XOR          22
    55                                  %define IR_NOT          23
    56                                  %define IR_SHL          24
    57                                  %define IR_SHR          25
    58                                  %define IR_EQ           30
    59                                  %define IR_NE           31
    60                                  %define IR_LT           32
    61                                  %define IR_LE           33
    62                                  %define IR_GT           34
    63                                  %define IR_GE           35
    64                                  %define IR_MOVE         40
    65                                  %define IR_LABEL        50
    66                                  %define IR_JUMP         51
    67                                  %define IR_JUMP_IF      52
    68                                  %define IR_JUMP_IF_NOT  53
    69                                  %define IR_RETURN       55
    70                                  %define IR_RETURN_VOID  56
    71                                  
    72                                  ; Token types for operators
    73                                  %define TOKEN_PLUS      20
    74                                  %define TOKEN_MINUS     21
    75                                  %define TOKEN_STAR      22
    76                                  %define TOKEN_SLASH     23
    77                                  %define TOKEN_PERCENT   24
    78                                  %define TOKEN_EQ_EQ     40
    79                                  %define TOKEN_BANG_EQ   41
    80                                  %define TOKEN_LT        42
    81                                  %define TOKEN_LT_EQ     43
    82                                  %define TOKEN_GT        44
    83                                  %define TOKEN_GT_EQ     45
    84                                  %define TOKEN_AND_AND   50
    85                                  %define TOKEN_OR_OR     51
    86                                  
    87                                  ; Type kinds
    88                                  %define TYPE_I32        2
    89                                  %define TYPE_VOID       13
    90                                  
    91                                  ; IROperand size (from ir.asm)
    92                                  %define IROperand_size  32
    93                                  
    94                                  section .bss
    95 00000000 <res 100h>                  break_label_stack:  resq 32     ; Stack of break labels for loops
    96 00000100 <res 100h>                  continue_label_stack: resq 32   ; Stack of continue labels for loops
    97 00000200 ????????????????            loop_depth:         resq 1      ; Current loop nesting depth
    98                                  
    99                                  section .text
   100                                  
   101                                  global ir_generate
   102                                  global ir_generate_program
   103                                  global ir_generate_function
   104                                  global ir_generate_statement
   105                                  global ir_generate_expression
   106                                  
   107                                  ; ============================================================================
   108                                  ; ir_generate - Main entry point for IR generation
   109                                  ; Parameters:
   110                                  ;   RCX = pointer to AST root (program node)
   111                                  ; Returns:
   112                                  ;   RAX = pointer to IRProgram
   113                                  ; ============================================================================
   114                                  ir_generate:
   115 00000000 55                          push rbp
   116 00000001 4889E5                      mov rbp, rsp
   117 00000004 4883EC20                    sub rsp, 32
   118 00000008 53                          push rbx
   119                                      
   120 00000009 4889CB                      mov rbx, rcx        ; Save AST root
   121                                      
   122                                      ; Create IR program
   123 0000000C E8(00000000)                call ir_program_create
   124 00000011 4885C0                      test rax, rax
   125 00000014 740C                        jz .error
   126                                      
   127 00000016 50                          push rax            ; Save program pointer
   128                                      
   129                                      ; Generate IR from program node
   130 00000017 4889D9                      mov rcx, rbx
   131 0000001A E80D000000                  call ir_generate_program
   132                                      
   133 0000001F 58                          pop rax             ; Return program pointer
   134 00000020 EB03                        jmp .done
   135                                      
   136                                  .error:
   137 00000022 4831C0                      xor rax, rax
   138                                      
   139                                  .done:
   140 00000025 5B                          pop rbx
   141 00000026 4883C420                    add rsp, 32
   142 0000002A 5D                          pop rbp
   143 0000002B C3                          ret
   144                                  
   145                                  ; ============================================================================
   146                                  ; ir_generate_program - Generate IR for program node
   147                                  ; Parameters:
   148                                  ;   RCX = pointer to program AST node
   149                                  ; ============================================================================
   150                                  ir_generate_program:
   151 0000002C 55                          push rbp
   152 0000002D 4889E5                      mov rbp, rsp
   153 00000030 4883EC20                    sub rsp, 32
   154 00000034 53                          push rbx
   155 00000035 4154                        push r12
   156                                      
   157 00000037 4889CB                      mov rbx, rcx
   158                                      
   159                                      ; Get declarations list
   160 0000003A 4C8B6308                    mov r12, [rbx + 8]      ; declarations at offset 8
   161                                      
   162                                  .gen_decl_loop:
   163 0000003E 4D85E4                      test r12, r12
   164 00000041 741E                        jz .done
   165                                      
   166                                      ; Get declaration node
   167 00000043 498B0424                    mov rax, [r12]
   168                                      
   169                                      ; Check node type
   170 00000047 488B08                      mov rcx, [rax]
   171 0000004A 4883F901                    cmp rcx, AST_FUNCTION
   172 0000004E 7402                        je .gen_function
   173                                      
   174                                      ; TODO: Handle other declaration types
   175 00000050 EB08                        jmp .next_decl
   176                                      
   177                                  .gen_function:
   178 00000052 4889C1                      mov rcx, rax
   179 00000055 E810000000                  call ir_generate_function
   180                                      
   181                                  .next_decl:
   182 0000005A 4D8B642408                  mov r12, [r12 + 8]      ; Next declaration
   183 0000005F EBDD                        jmp .gen_decl_loop
   184                                      
   185                                  .done:
   186 00000061 415C                        pop r12
   187 00000063 5B                          pop rbx
   188 00000064 4883C420                    add rsp, 32
   189 00000068 5D                          pop rbp
   190 00000069 C3                          ret
   191                                  
   192                                  ; ============================================================================
   193                                  ; ir_generate_function - Generate IR for function
   194                                  ; Parameters:
   195                                  ;   RCX = pointer to function AST node
   196                                  ; ============================================================================
   197                                  ir_generate_function:
   198 0000006A 55                          push rbp
   199 0000006B 4889E5                      mov rbp, rsp
   200 0000006E 4883EC40                    sub rsp, 64
   201 00000072 53                          push rbx
   202 00000073 4154                        push r12
   203                                      
   204 00000075 4889CB                      mov rbx, rcx        ; Function AST node
   205                                      
   206                                      ; Reset loop depth
   207 00000078 48C705(00020000)00-         mov qword [loop_depth], 0
   207 00000080 000000             
   208                                      
   209                                      ; Get function info
   210 00000083 488B4B10                    mov rcx, [rbx + 16]     ; name
   211 00000087 488B5318                    mov rdx, [rbx + 24]     ; name_len
   212                                      
   213                                      ; Get return type
   214 0000008B 4C8B6330                    mov r12, [rbx + 48]     ; return_type node
   215 0000008F 4D85E4                      test r12, r12
   216 00000092 7407                        jz .void_return
   217 00000094 4D8B442410                  mov r8, [r12 + 16]      ; type kind
   218 00000099 EB06                        jmp .create_func
   219                                      
   220                                  .void_return:
   221 0000009B 41B80D000000                mov r8, TYPE_VOID
   222                                      
   223                                  .create_func:
   224 000000A1 E8(00000000)                call ir_function_create
   225 000000A6 4885C0                      test rax, rax
   226 000000A9 7411                        jz .error
   227                                      
   228                                      ; Generate IR for function body
   229 000000AB 4C8B6338                    mov r12, [rbx + 56]     ; body (block statement)
   230 000000AF 4D85E4                      test r12, r12
   231 000000B2 7408                        jz .no_body
   232                                      
   233 000000B4 4C89E1                      mov rcx, r12
   234 000000B7 E809000000                  call ir_generate_statement
   235                                      
   236                                  .no_body:
   237                                  .error:
   238 000000BC 415C                        pop r12
   239 000000BE 5B                          pop rbx
   240 000000BF 4883C440                    add rsp, 64
   241 000000C3 5D                          pop rbp
   242 000000C4 C3                          ret
   243                                  
   244                                  ; ============================================================================
   245                                  ; ir_generate_statement - Generate IR for statement
   246                                  ; Parameters:
   247                                  ;   RCX = pointer to statement AST node
   248                                  ; Returns:
   249                                  ;   Nothing
   250                                  ; ============================================================================
   251                                  ir_generate_statement:
   252 000000C5 55                          push rbp
   253 000000C6 4889E5                      mov rbp, rsp
   254 000000C9 4883EC20                    sub rsp, 32
   255 000000CD 53                          push rbx
   256                                      
   257 000000CE 4889CB                      mov rbx, rcx
   258 000000D1 4885DB                      test rbx, rbx
   259 000000D4 0F8486000000                jz .done
   260                                      
   261                                      ; Get statement type
   262 000000DA 488B03                      mov rax, [rbx]
   263                                      
   264                                      ; Dispatch based on statement type
   265 000000DD 4883F814                    cmp rax, AST_BLOCK
   266 000000E1 742C                        je .block
   267 000000E3 4883F815                    cmp rax, AST_LET_STMT
   268 000000E7 7430                        je .let_stmt
   269 000000E9 4883F816                    cmp rax, AST_ASSIGN_STMT
   270 000000ED 7434                        je .assign_stmt
   271 000000EF 4883F81A                    cmp rax, AST_RETURN_STMT
   272 000000F3 7438                        je .return_stmt
   273 000000F5 4883F817                    cmp rax, AST_IF_STMT
   274 000000F9 743C                        je .if_stmt
   275 000000FB 4883F818                    cmp rax, AST_WHILE_STMT
   276 000000FF 7440                        je .while_stmt
   277 00000101 4883F819                    cmp rax, AST_FOR_STMT
   278 00000105 7444                        je .for_stmt
   279 00000107 4883F81D                    cmp rax, AST_EXPR_STMT
   280 0000010B 7448                        je .expr_stmt
   281                                      
   282                                      ; Unknown statement type
   283 0000010D EB51                        jmp .done
   284                                      
   285                                  .block:
   286 0000010F 4889D9                      mov rcx, rbx
   287 00000112 E850000000                  call ir_generate_block
   288 00000117 EB47                        jmp .done
   289                                      
   290                                  .let_stmt:
   291 00000119 4889D9                      mov rcx, rbx
   292 0000011C E876000000                  call ir_generate_let
   293 00000121 EB3D                        jmp .done
   294                                      
   295                                  .assign_stmt:
   296 00000123 4889D9                      mov rcx, rbx
   297 00000126 E8CB000000                  call ir_generate_assign
   298 0000012B EB33                        jmp .done
   299                                      
   300                                  .return_stmt:
   301 0000012D 4889D9                      mov rcx, rbx
   302 00000130 E81E010000                  call ir_generate_return
   303 00000135 EB29                        jmp .done
   304                                      
   305                                  .if_stmt:
   306 00000137 4889D9                      mov rcx, rbx
   307 0000013A E847010000                  call ir_generate_if
   308 0000013F EB1F                        jmp .done
   309                                      
   310                                  .while_stmt:
   311 00000141 4889D9                      mov rcx, rbx
   312 00000144 E89E010000                  call ir_generate_while
   313 00000149 EB15                        jmp .done
   314                                      
   315                                  .for_stmt:
   316 0000014B 4889D9                      mov rcx, rbx
   317 0000014E E8FD010000                  call ir_generate_for
   318 00000153 EB0B                        jmp .done
   319                                      
   320                                  .expr_stmt:
   321                                      ; Just generate the expression (for side effects like function calls)
   322 00000155 488B4B10                    mov rcx, [rbx + 16]
   323 00000159 E813020000                  call ir_generate_expression
   324 0000015E EB00                        jmp .done
   325                                      
   326                                  .done:
   327 00000160 5B                          pop rbx
   328 00000161 4883C420                    add rsp, 32
   329 00000165 5D                          pop rbp
   330 00000166 C3                          ret
   331                                  
   332                                  ; ============================================================================
   333                                  ; ir_generate_block - Generate IR for block statement
   334                                  ; Parameters:
   335                                  ;   RCX = pointer to block AST node
   336                                  ; ============================================================================
   337                                  ir_generate_block:
   338 00000167 55                          push rbp
   339 00000168 4889E5                      mov rbp, rsp
   340 0000016B 4883EC20                    sub rsp, 32
   341 0000016F 53                          push rbx
   342 00000170 4154                        push r12
   343                                      
   344 00000172 4889CB                      mov rbx, rcx
   345                                      
   346                                      ; Get statements list
   347 00000175 4C8B6308                    mov r12, [rbx + 8]      ; statements at offset 8
   348                                      
   349                                  .gen_stmt_loop:
   350 00000179 4D85E4                      test r12, r12
   351 0000017C 7410                        jz .done
   352                                      
   353                                      ; Generate statement
   354 0000017E 498B0C24                    mov rcx, [r12]
   355 00000182 E83EFFFFFF                  call ir_generate_statement
   356                                      
   357                                      ; Next statement
   358 00000187 4D8B642408                  mov r12, [r12 + 8]
   359 0000018C EBEB                        jmp .gen_stmt_loop
   360                                      
   361                                  .done:
   362 0000018E 415C                        pop r12
   363 00000190 5B                          pop rbx
   364 00000191 4883C420                    add rsp, 32
   365 00000195 5D                          pop rbp
   366 00000196 C3                          ret
   367                                  
   368                                  ; ============================================================================
   369                                  ; ir_generate_let - Generate IR for let statement
   370                                  ; Parameters:
   371                                  ;   RCX = pointer to let statement AST node
   372                                  ; ============================================================================
   373                                  ir_generate_let:
   374 00000197 55                          push rbp
   375 00000198 4889E5                      mov rbp, rsp
   376 0000019B 4883EC60                    sub rsp, 96
   377 0000019F 53                          push rbx
   378 000001A0 4154                        push r12
   379 000001A2 4155                        push r13
   380                                      
   381 000001A4 4889CB                      mov rbx, rcx
   382                                      
   383                                      ; Check if there's an initializer
   384 000001A7 488B4B30                    mov rcx, [rbx + 48]     ; initializer at offset 48
   385 000001AB 4885C9                      test rcx, rcx
   386 000001AE 743B                        jz .no_init
   387                                      
   388                                      ; Generate expression for initializer
   389 000001B0 E8BC010000                  call ir_generate_expression
   390 000001B5 4989C4                      mov r12, rax            ; Save result operand
   391                                      
   392                                      ; Create variable operand for destination
   393 000001B8 B920000000                  mov rcx, IROperand_size
   394 000001BD E8(00000000)                call arena_alloc
   395 000001C2 4885C0                      test rax, rax
   396 000001C5 7424                        jz .no_init
   397                                      
   398 000001C7 4989C5                      mov r13, rax            ; dest operand
   399                                      
   400                                      ; Fill in variable operand
   401 000001CA 4C89E9                      mov rcx, r13
   402 000001CD 488B5310                    mov rdx, [rbx + 16]     ; variable name
   403 000001D1 4C8B4318                    mov r8, [rbx + 24]      ; name length
   404 000001D5 41B902000000                mov r9, TYPE_I32        ; TODO: get actual type
   405 000001DB E8(00000000)                call ir_operand_var
   406                                      
   407                                      ; Emit move instruction: var = temp
   408 000001E0 4C89E9                      mov rcx, r13            ; dest
   409 000001E3 4C89E2                      mov rdx, r12            ; src (result from expression)
   410 000001E6 E8(00000000)                call ir_emit_move
   411                                      
   412                                  .no_init:
   413 000001EB 415D                        pop r13
   414 000001ED 415C                        pop r12
   415 000001EF 5B                          pop rbx
   416 000001F0 4883C460                    add rsp, 96
   417 000001F4 5D                          pop rbp
   418 000001F5 C3                          ret
   419                                  
   420                                  ; ============================================================================
   421                                  ; ir_generate_assign - Generate IR for assignment statement
   422                                  ; Parameters:
   423                                  ;   RCX = pointer to assignment AST node
   424                                  ; ============================================================================
   425                                  ir_generate_assign:
   426 000001F6 55                          push rbp
   427 000001F7 4889E5                      mov rbp, rsp
   428 000001FA 4883EC60                    sub rsp, 96
   429 000001FE 53                          push rbx
   430 000001FF 4154                        push r12
   431 00000201 4155                        push r13
   432                                      
   433 00000203 4889CB                      mov rbx, rcx
   434                                      
   435                                      ; Generate value expression
   436 00000206 488B4B18                    mov rcx, [rbx + 24]     ; value at offset 24
   437 0000020A E862010000                  call ir_generate_expression
   438 0000020F 4989C4                      mov r12, rax            ; Save result operand
   439                                      
   440                                      ; Get target (should be identifier for now)
   441 00000212 4C8B6B10                    mov r13, [rbx + 16]     ; target at offset 16
   442                                      
   443                                      ; Create variable operand for target
   444 00000216 B920000000                  mov rcx, IROperand_size
   445 0000021B E8(00000000)                call arena_alloc
   446 00000220 4885C0                      test rax, rax
   447 00000223 7423                        jz .done
   448                                      
   449 00000225 50                          push rax
   450 00000226 4889C1                      mov rcx, rax
   451 00000229 498B5510                    mov rdx, [r13 + 16]     ; identifier name
   452 0000022D 4D8B4518                    mov r8, [r13 + 24]      ; name length
   453 00000231 41B902000000                mov r9, TYPE_I32        ; TODO: get actual type
   454 00000237 E8(00000000)                call ir_operand_var
   455 0000023C 58                          pop rax
   456                                      
   457                                      ; Emit move: target = value
   458 0000023D 4889C1                      mov rcx, rax            ; dest
   459 00000240 4C89E2                      mov rdx, r12            ; src
   460 00000243 E8(00000000)                call ir_emit_move
   461                                      
   462                                  .done:
   463 00000248 415D                        pop r13
   464 0000024A 415C                        pop r12
   465 0000024C 5B                          pop rbx
   466 0000024D 4883C460                    add rsp, 96
   467 00000251 5D                          pop rbp
   468 00000252 C3                          ret
   469                                  
   470                                  ; ============================================================================
   471                                  ; ir_generate_return - Generate IR for return statement
   472                                  ; Parameters:
   473                                  ;   RCX = pointer to return statement AST node
   474                                  ; ============================================================================
   475                                  ir_generate_return:
   476 00000253 55                          push rbp
   477 00000254 4889E5                      mov rbp, rsp
   478 00000257 4883EC20                    sub rsp, 32
   479 0000025B 53                          push rbx
   480                                      
   481 0000025C 4889CB                      mov rbx, rcx
   482                                      
   483                                      ; Check if there's a return value
   484 0000025F 488B4B10                    mov rcx, [rbx + 16]     ; value at offset 16
   485 00000263 4885C9                      test rcx, rcx
   486 00000266 740F                        jz .void_return
   487                                      
   488                                      ; Generate expression
   489 00000268 E804010000                  call ir_generate_expression
   490                                      
   491                                      ; Emit return with value
   492 0000026D 4889C1                      mov rcx, rax
   493 00000270 E8(00000000)                call ir_emit_return
   494 00000275 EB08                        jmp .done
   495                                      
   496                                  .void_return:
   497                                      ; Emit void return
   498 00000277 4831C9                      xor rcx, rcx
   499 0000027A E8(00000000)                call ir_emit_return
   500                                      
   501                                  .done:
   502 0000027F 5B                          pop rbx
   503 00000280 4883C420                    add rsp, 32
   504 00000284 5D                          pop rbp
   505 00000285 C3                          ret
   506                                  
   507                                  ; ============================================================================
   508                                  ; ir_generate_if - Generate IR for if statement
   509                                  ; Parameters:
   510                                  ;   RCX = pointer to if statement AST node
   511                                  ; ============================================================================
   512                                  ir_generate_if:
   513 00000286 55                          push rbp
   514 00000287 4889E5                      mov rbp, rsp
   515 0000028A 4883EC60                    sub rsp, 96
   516 0000028E 53                          push rbx
   517 0000028F 4154                        push r12
   518 00000291 4155                        push r13
   519 00000293 4156                        push r14
   520                                      
   521 00000295 4889CB                      mov rbx, rcx
   522                                      
   523                                      ; Allocate labels
   524 00000298 E8(00000000)                call ir_new_label
   525 0000029D 4989C4                      mov r12, rax            ; else_label or end_label
   526                                      
   527 000002A0 E8(00000000)                call ir_new_label
   528 000002A5 4989C5                      mov r13, rax            ; end_label
   529                                      
   530                                      ; Generate condition expression
   531 000002A8 488B4B10                    mov rcx, [rbx + 16]     ; condition at offset 16
   532 000002AC E8C0000000                  call ir_generate_expression
   533 000002B1 4989C6                      mov r14, rax            ; Save condition result
   534                                      
   535                                      ; Check if there's an else branch
   536 000002B4 488B4320                    mov rax, [rbx + 32]     ; else_block at offset 32
   537 000002B8 4885C0                      test rax, rax
   538 000002BB 7414                        jz .no_else
   539                                      
   540                                      ; Emit: JUMP_IF_NOT condition, else_label
   541                                      ; TODO: emit jump_if_not instruction
   542                                      
   543                                      ; Generate then block
   544 000002BD 488B4B18                    mov rcx, [rbx + 24]     ; then_block at offset 24
   545 000002C1 E8FFFDFFFF                  call ir_generate_statement
   546                                      
   547                                      ; Emit: JUMP end_label
   548                                      ; TODO: emit jump instruction
   549                                      
   550                                      ; Emit: else_label:
   551                                      ; TODO: emit label
   552                                      
   553                                      ; Generate else block
   554 000002C6 488B4B20                    mov rcx, [rbx + 32]
   555 000002CA E8F6FDFFFF                  call ir_generate_statement
   556                                      
   557 000002CF EB09                        jmp .end_if
   558                                      
   559                                  .no_else:
   560                                      ; Emit: JUMP_IF_NOT condition, end_label
   561                                      ; TODO: emit jump_if_not instruction
   562                                      
   563                                      ; Generate then block
   564 000002D1 488B4B18                    mov rcx, [rbx + 24]
   565 000002D5 E8EBFDFFFF                  call ir_generate_statement
   566                                      
   567                                  .end_if:
   568                                      ; Emit: end_label:
   569                                      ; TODO: emit label
   570                                      
   571 000002DA 415E                        pop r14
   572 000002DC 415D                        pop r13
   573 000002DE 415C                        pop r12
   574 000002E0 5B                          pop rbx
   575 000002E1 4883C460                    add rsp, 96
   576 000002E5 5D                          pop rbp
   577 000002E6 C3                          ret
   578                                  
   579                                  ; ============================================================================
   580                                  ; ir_generate_while - Generate IR for while loop
   581                                  ; Parameters:
   582                                  ;   RCX = pointer to while statement AST node
   583                                  ; ============================================================================
   584                                  ir_generate_while:
   585 000002E7 55                          push rbp
   586 000002E8 4889E5                      mov rbp, rsp
   587 000002EB 4883EC60                    sub rsp, 96
   588 000002EF 53                          push rbx
   589 000002F0 4154                        push r12
   590 000002F2 4155                        push r13
   591 000002F4 4156                        push r14
   592                                      
   593 000002F6 4889CB                      mov rbx, rcx
   594                                      
   595                                      ; Allocate labels
   596 000002F9 E8(00000000)                call ir_new_label
   597 000002FE 4989C4                      mov r12, rax            ; loop_start
   598                                      
   599 00000301 E8(00000000)                call ir_new_label
   600 00000306 4989C5                      mov r13, rax            ; loop_end
   601                                      
   602                                      ; Push labels to break/continue stacks
   603 00000309 488B05(00020000)            mov rax, [loop_depth]
   604 00000310 4C8924C5[00010000]          mov [continue_label_stack + rax * 8], r12
   605 00000318 4C892CC5[00000000]          mov [break_label_stack + rax * 8], r13
   606 00000320 48FF05(00020000)            inc qword [loop_depth]
   607                                      
   608                                      ; Emit: loop_start:
   609                                      ; TODO: emit label
   610                                      
   611                                      ; Generate condition
   612 00000327 488B4B10                    mov rcx, [rbx + 16]
   613 0000032B E841000000                  call ir_generate_expression
   614 00000330 4989C6                      mov r14, rax
   615                                      
   616                                      ; Emit: JUMP_IF_NOT condition, loop_end
   617                                      ; TODO: emit jump_if_not
   618                                      
   619                                      ; Generate body
   620 00000333 488B4B18                    mov rcx, [rbx + 24]
   621 00000337 E889FDFFFF                  call ir_generate_statement
   622                                      
   623                                      ; Emit: JUMP loop_start
   624                                      ; TODO: emit jump
   625                                      
   626                                      ; Emit: loop_end:
   627                                      ; TODO: emit label
   628                                      
   629                                      ; Pop loop depth
   630 0000033C 48FF0D(00020000)            dec qword [loop_depth]
   631                                      
   632 00000343 415E                        pop r14
   633 00000345 415D                        pop r13
   634 00000347 415C                        pop r12
   635 00000349 5B                          pop rbx
   636 0000034A 4883C460                    add rsp, 96
   637 0000034E 5D                          pop rbp
   638 0000034F C3                          ret
   639                                  
   640                                  ; ============================================================================
   641                                  ; ir_generate_for - Generate IR for for loop
   642                                  ; Parameters:
   643                                  ;   RCX = pointer to for statement AST node
   644                                  ; ============================================================================
   645                                  ir_generate_for:
   646 00000350 55                          push rbp
   647 00000351 4889E5                      mov rbp, rsp
   648 00000354 4883EC20                    sub rsp, 32
   649 00000358 53                          push rbx
   650                                      
   651 00000359 4889CB                      mov rbx, rcx
   652                                      
   653                                      ; For loop: similar to while but with implicit iterator
   654                                      ; TODO: Implement full for loop generation
   655                                      ; For now, just generate body
   656                                      
   657 0000035C 488B4B30                    mov rcx, [rbx + 48]     ; body
   658 00000360 4885C9                      test rcx, rcx
   659 00000363 7405                        jz .done
   660                                      
   661 00000365 E85BFDFFFF                  call ir_generate_statement
   662                                      
   663                                  .done:
   664 0000036A 5B                          pop rbx
   665 0000036B 4883C420                    add rsp, 32
   666 0000036F 5D                          pop rbp
   667 00000370 C3                          ret
   668                                  
   669                                  ; ============================================================================
   670                                  ; ir_generate_expression - Generate IR for expression
   671                                  ; Parameters:
   672                                  ;   RCX = pointer to expression AST node
   673                                  ; Returns:
   674                                  ;   RAX = pointer to IROperand (result)
   675                                  ; ============================================================================
   676                                  ir_generate_expression:
   677 00000371 55                          push rbp
   678 00000372 4889E5                      mov rbp, rsp
   679 00000375 4883EC20                    sub rsp, 32
   680 00000379 53                          push rbx
   681                                      
   682 0000037A 4889CB                      mov rbx, rcx
   683 0000037D 4885DB                      test rbx, rbx
   684 00000380 741B                        jz .error
   685                                      
   686                                      ; Get expression type
   687 00000382 488B03                      mov rax, [rbx]
   688                                      
   689 00000385 4883F834                    cmp rax, AST_LITERAL_EXPR
   690 00000389 7417                        je .literal
   691 0000038B 4883F835                    cmp rax, AST_IDENTIFIER
   692 0000038F 741B                        je .identifier
   693 00000391 4883F832                    cmp rax, AST_BINARY_EXPR
   694 00000395 741F                        je .binary
   695 00000397 4883F833                    cmp rax, AST_UNARY_EXPR
   696 0000039B 7423                        je .unary
   697                                      
   698                                  .error:
   699 0000039D 4831C0                      xor rax, rax
   700 000003A0 EB28                        jmp .done
   701                                      
   702                                  .literal:
   703 000003A2 4889D9                      mov rcx, rbx
   704 000003A5 E827000000                  call ir_generate_literal
   705 000003AA EB1E                        jmp .done
   706                                      
   707                                  .identifier:
   708 000003AC 4889D9                      mov rcx, rbx
   709 000003AF E860000000                  call ir_generate_identifier
   710 000003B4 EB14                        jmp .done
   711                                      
   712                                  .binary:
   713 000003B6 4889D9                      mov rcx, rbx
   714 000003B9 E89D000000                  call ir_generate_binary
   715 000003BE EB0A                        jmp .done
   716                                      
   717                                  .unary:
   718 000003C0 4889D9                      mov rcx, rbx
   719 000003C3 E829010000                  call ir_generate_unary
   720 000003C8 EB00                        jmp .done
   721                                      
   722                                  .done:
   723 000003CA 5B                          pop rbx
   724 000003CB 4883C420                    add rsp, 32
   725 000003CF 5D                          pop rbp
   726 000003D0 C3                          ret
   727                                  
   728                                  ; ============================================================================
   729                                  ; ir_generate_literal - Generate IR for literal expression
   730                                  ; Parameters:
   731                                  ;   RCX = pointer to literal AST node
   732                                  ; Returns:
   733                                  ;   RAX = pointer to IROperand (constant)
   734                                  ; ============================================================================
   735                                  ir_generate_literal:
   736 000003D1 55                          push rbp
   737 000003D2 4889E5                      mov rbp, rsp
   738 000003D5 4883EC30                    sub rsp, 48
   739 000003D9 53                          push rbx
   740 000003DA 4154                        push r12
   741                                      
   742 000003DC 4889CB                      mov rbx, rcx
   743                                      
   744                                      ; Allocate operand
   745 000003DF B920000000                  mov rcx, IROperand_size
   746 000003E4 E8(00000000)                call arena_alloc
   747 000003E9 4885C0                      test rax, rax
   748 000003EC 741A                        jz .error
   749                                      
   750 000003EE 4989C4                      mov r12, rax
   751                                      
   752                                      ; Create constant operand
   753 000003F1 4C89E1                      mov rcx, r12
   754 000003F4 488B5310                    mov rdx, [rbx + 16]     ; value
   755 000003F8 41B802000000                mov r8, TYPE_I32        ; TODO: get actual type
   756 000003FE E8(00000000)                call ir_operand_const
   757                                      
   758 00000403 4C89E0                      mov rax, r12
   759 00000406 EB03                        jmp .done
   760                                      
   761                                  .error:
   762 00000408 4831C0                      xor rax, rax
   763                                      
   764                                  .done:
   765 0000040B 415C                        pop r12
   766 0000040D 5B                          pop rbx
   767 0000040E 4883C430                    add rsp, 48
   768 00000412 5D                          pop rbp
   769 00000413 C3                          ret
   770                                  
   771                                  ; ============================================================================
   772                                  ; ir_generate_identifier - Generate IR for identifier expression
   773                                  ; Parameters:
   774                                  ;   RCX = pointer to identifier AST node
   775                                  ; Returns:
   776                                  ;   RAX = pointer to IROperand (variable)
   777                                  ; ============================================================================
   778                                  ir_generate_identifier:
   779 00000414 55                          push rbp
   780 00000415 4889E5                      mov rbp, rsp
   781 00000418 4883EC30                    sub rsp, 48
   782 0000041C 53                          push rbx
   783 0000041D 4154                        push r12
   784                                      
   785 0000041F 4889CB                      mov rbx, rcx
   786                                      
   787                                      ; Allocate operand
   788 00000422 B920000000                  mov rcx, IROperand_size
   789 00000427 E8(00000000)                call arena_alloc
   790 0000042C 4885C0                      test rax, rax
   791 0000042F 741E                        jz .error
   792                                      
   793 00000431 4989C4                      mov r12, rax
   794                                      
   795                                      ; Create variable operand
   796 00000434 4C89E1                      mov rcx, r12
   797 00000437 488B5310                    mov rdx, [rbx + 16]     ; name
   798 0000043B 4C8B4318                    mov r8, [rbx + 24]      ; length
   799 0000043F 41B902000000                mov r9, TYPE_I32        ; TODO: get actual type
   800 00000445 E8(00000000)                call ir_operand_var
   801                                      
   802 0000044A 4C89E0                      mov rax, r12
   803 0000044D EB03                        jmp .done
   804                                      
   805                                  .error:
   806 0000044F 4831C0                      xor rax, rax
   807                                      
   808                                  .done:
   809 00000452 415C                        pop r12
   810 00000454 5B                          pop rbx
   811 00000455 4883C430                    add rsp, 48
   812 00000459 5D                          pop rbp
   813 0000045A C3                          ret
   814                                  
   815                                  ; ============================================================================
   816                                  ; ir_generate_binary - Generate IR for binary expression
   817                                  ; Parameters:
   818                                  ;   RCX = pointer to binary expression AST node
   819                                  ; Returns:
   820                                  ;   RAX = pointer to IROperand (temporary with result)
   821                                  ; ============================================================================
   822                                  ir_generate_binary:
   823 0000045B 55                          push rbp
   824 0000045C 4889E5                      mov rbp, rsp
   825 0000045F 4881EC80000000              sub rsp, 128
   826 00000466 53                          push rbx
   827 00000467 4154                        push r12
   828 00000469 4155                        push r13
   829 0000046B 4156                        push r14
   830 0000046D 4157                        push r15
   831                                      
   832 0000046F 4889CB                      mov rbx, rcx
   833                                      
   834                                      ; Generate left operand
   835 00000472 488B4B10                    mov rcx, [rbx + 16]
   836 00000476 E8F6FEFFFF                  call ir_generate_expression
   837 0000047B 4989C4                      mov r12, rax            ; left operand
   838                                      
   839                                      ; Generate right operand
   840 0000047E 488B4B18                    mov rcx, [rbx + 24]
   841 00000482 E8EAFEFFFF                  call ir_generate_expression
   842 00000487 4989C5                      mov r13, rax            ; right operand
   843                                      
   844                                      ; Get operator and convert to IR opcode
   845 0000048A 4C8B7320                    mov r14, [rbx + 32]     ; operator token type
   846 0000048E E8C9000000                  call token_to_ir_opcode
   847 00000493 4989C7                      mov r15, rax            ; IR opcode
   848                                      
   849                                      ; Allocate new temporary for result
   850 00000496 E8(00000000)                call ir_new_temp
   851 0000049B 50                          push rax
   852                                      
   853                                      ; Create temporary operand for destination
   854 0000049C B920000000                  mov rcx, IROperand_size
   855 000004A1 E8(00000000)                call arena_alloc
   856 000004A6 4885C0                      test rax, rax
   857 000004A9 742D                        jz .error
   858                                      
   859 000004AB 4889C3                      mov rbx, rax            ; dest operand
   860 000004AE 58                          pop rax
   861 000004AF 50                          push rax
   862                                      
   863 000004B0 4889D9                      mov rcx, rbx
   864 000004B3 4889C2                      mov rdx, rax            ; temp number
   865 000004B6 41B802000000                mov r8, TYPE_I32        ; TODO: get actual type
   866 000004BC E8(00000000)                call ir_operand_temp
   867                                      
   868 000004C1 58                          pop rax
   869                                      
   870                                      ; Emit binary instruction
   871 000004C2 4C89F9                      mov rcx, r15            ; opcode
   872 000004C5 4889DA                      mov rdx, rbx            ; dest
   873 000004C8 4D89E0                      mov r8, r12             ; src1
   874 000004CB 4D89E9                      mov r9, r13             ; src2
   875 000004CE E8(00000000)                call ir_emit_binary
   876                                      
   877                                      ; Return dest operand
   878 000004D3 4889D8                      mov rax, rbx
   879 000004D6 EB07                        jmp .done
   880                                      
   881                                  .error:
   882 000004D8 4883C408                    add rsp, 8              ; Clean up pushed temp
   883 000004DC 4831C0                      xor rax, rax
   884                                      
   885                                  .done:
   886 000004DF 415F                        pop r15
   887 000004E1 415E                        pop r14
   888 000004E3 415D                        pop r13
   889 000004E5 415C                        pop r12
   890 000004E7 5B                          pop rbx
   891 000004E8 4881C480000000              add rsp, 128
   892 000004EF 5D                          pop rbp
   893 000004F0 C3                          ret
   894                                  
   895                                  ; ============================================================================
   896                                  ; ir_generate_unary - Generate IR for unary expression
   897                                  ; Parameters:
   898                                  ;   RCX = pointer to unary expression AST node
   899                                  ; Returns:
   900                                  ;   RAX = pointer to IROperand (temporary with result)
   901                                  ; ============================================================================
   902                                  ir_generate_unary:
   903 000004F1 55                          push rbp
   904 000004F2 4889E5                      mov rbp, rsp
   905 000004F5 4883EC60                    sub rsp, 96
   906 000004F9 53                          push rbx
   907 000004FA 4154                        push r12
   908 000004FC 4155                        push r13
   909 000004FE 4156                        push r14
   910                                      
   911 00000500 4889CB                      mov rbx, rcx
   912                                      
   913                                      ; Generate operand
   914 00000503 488B4B10                    mov rcx, [rbx + 16]
   915 00000507 E865FEFFFF                  call ir_generate_expression
   916 0000050C 4989C4                      mov r12, rax            ; operand
   917                                      
   918                                      ; Get operator
   919 0000050F 4C8B6B08                    mov r13, [rbx + 8]      ; operator token type
   920                                      ; TODO: Convert to IR opcode
   921 00000513 41BE05000000                mov r14, IR_NEG         ; Default to NEG for now
   922                                      
   923                                      ; Allocate temporary
   924 00000519 E8(00000000)                call ir_new_temp
   925 0000051E 50                          push rax
   926                                      
   927 0000051F B920000000                  mov rcx, IROperand_size
   928 00000524 E8(00000000)                call arena_alloc
   929 00000529 4885C0                      test rax, rax
   930 0000052C 741A                        jz .error
   931                                      
   932 0000052E 4889C3                      mov rbx, rax
   933 00000531 58                          pop rax
   934                                      
   935 00000532 4889D9                      mov rcx, rbx
   936 00000535 4889C2                      mov rdx, rax
   937 00000538 41B802000000                mov r8, TYPE_I32
   938 0000053E E8(00000000)                call ir_operand_temp
   939                                      
   940                                      ; TODO: Emit unary instruction
   941                                      
   942 00000543 4889D8                      mov rax, rbx
   943 00000546 EB07                        jmp .done
   944                                      
   945                                  .error:
   946 00000548 4883C408                    add rsp, 8
   947 0000054C 4831C0                      xor rax, rax
   948                                      
   949                                  .done:
   950 0000054F 415E                        pop r14
   951 00000551 415D                        pop r13
   952 00000553 415C                        pop r12
   953 00000555 5B                          pop rbx
   954 00000556 4883C460                    add rsp, 96
   955 0000055A 5D                          pop rbp
   956 0000055B C3                          ret
   957                                  
   958                                  ; ============================================================================
   959                                  ; token_to_ir_opcode - Convert token type to IR opcode
   960                                  ; Parameters:
   961                                  ;   RAX = token type
   962                                  ; Returns:
   963                                  ;   RAX = IR opcode
   964                                  ; ============================================================================
   965                                  token_to_ir_opcode:
   966 0000055C 55                          push rbp
   967 0000055D 4889E5                      mov rbp, rsp
   968                                      
   969 00000560 4883F814                    cmp rax, TOKEN_PLUS
   970 00000564 7443                        je .plus
   971 00000566 4883F815                    cmp rax, TOKEN_MINUS
   972 0000056A 7444                        je .minus
   973 0000056C 4883F816                    cmp rax, TOKEN_STAR
   974 00000570 7445                        je .mul
   975 00000572 4883F817                    cmp rax, TOKEN_SLASH
   976 00000576 7446                        je .div
   977 00000578 4883F818                    cmp rax, TOKEN_PERCENT
   978 0000057C 7447                        je .mod
   979 0000057E 4883F828                    cmp rax, TOKEN_EQ_EQ
   980 00000582 7448                        je .eq
   981 00000584 4883F829                    cmp rax, TOKEN_BANG_EQ
   982 00000588 7449                        je .ne
   983 0000058A 4883F82A                    cmp rax, TOKEN_LT
   984 0000058E 744A                        je .lt
   985 00000590 4883F82B                    cmp rax, TOKEN_LT_EQ
   986 00000594 744B                        je .le
   987 00000596 4883F82C                    cmp rax, TOKEN_GT
   988 0000059A 744C                        je .gt
   989 0000059C 4883F82D                    cmp rax, TOKEN_GT_EQ
   990 000005A0 744D                        je .ge
   991                                      
   992                                      ; Default to ADD
   993 000005A2 B800000000                  mov rax, IR_ADD
   994 000005A7 EB4D                        jmp .done
   995                                      
   996                                  .plus:
   997 000005A9 B800000000                  mov rax, IR_ADD
   998 000005AE EB46                        jmp .done
   999                                  .minus:
  1000 000005B0 B801000000                  mov rax, IR_SUB
  1001 000005B5 EB3F                        jmp .done
  1002                                  .mul:
  1003 000005B7 B802000000                  mov rax, IR_MUL
  1004 000005BC EB38                        jmp .done
  1005                                  .div:
  1006 000005BE B803000000                  mov rax, IR_DIV
  1007 000005C3 EB31                        jmp .done
  1008                                  .mod:
  1009 000005C5 B804000000                  mov rax, IR_MOD
  1010 000005CA EB2A                        jmp .done
  1011                                  .eq:
  1012 000005CC B81E000000                  mov rax, IR_EQ
  1013 000005D1 EB23                        jmp .done
  1014                                  .ne:
  1015 000005D3 B81F000000                  mov rax, IR_NE
  1016 000005D8 EB1C                        jmp .done
  1017                                  .lt:
  1018 000005DA B820000000                  mov rax, IR_LT
  1019 000005DF EB15                        jmp .done
  1020                                  .le:
  1021 000005E1 B821000000                  mov rax, IR_LE
  1022 000005E6 EB0E                        jmp .done
  1023                                  .gt:
  1024 000005E8 B822000000                  mov rax, IR_GT
  1025 000005ED EB07                        jmp .done
  1026                                  .ge:
  1027 000005EF B823000000                  mov rax, IR_GE
  1028 000005F4 EB00                        jmp .done
  1029                                      
  1030                                  .done:
  1031 000005F6 5D                          pop rbp
  1032 000005F7 C3                          ret
