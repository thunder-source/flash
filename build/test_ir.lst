     1                                  ; ============================================================================
     2                                  ; IR Generation Test
     3                                  ; Tests the Three-Address Code IR generation from AST
     4                                  ; ============================================================================
     5                                  
     6                                  bits 64
     7                                  default rel
     8                                  
     9                                  extern ir_program_create
    10                                  extern ir_function_create
    11                                  extern ir_generate
    12                                  extern ir_new_temp
    13                                  extern ir_emit_binary
    14                                  extern arena_init
    15                                  extern ExitProcess
    16                                  extern GetStdHandle
    17                                  extern WriteFile
    18                                  
    19                                  %define STD_OUTPUT_HANDLE -11
    20                                  %define IR_ADD 0
    21                                  %define TYPE_I32 2
    22                                  %define IROperand_size 32
    23                                  
    24                                  section .data
    25 00000000 3D3D3D204952204765-         msg_header db "=== IR Generation Test ===", 13, 10, 0
    25 00000009 6E65726174696F6E20-
    25 00000012 54657374203D3D3D0D-
    25 0000001B 0A00               
    26 0000001D 5465737420313A2043-         msg_test1 db "Test 1: Create IR program... ", 0
    26 00000026 726561746520495220-
    26 0000002F 70726F6772616D2E2E-
    26 00000038 2E2000             
    27 0000003B 5465737420323A2043-         msg_test2 db "Test 2: Create IR function... ", 0
    27 00000044 726561746520495220-
    27 0000004D 66756E6374696F6E2E-
    27 00000056 2E2E2000           
    28 0000005A 5465737420333A2041-         msg_test3 db "Test 3: Allocate temporary... ", 0
    28 00000063 6C6C6F636174652074-
    28 0000006C 656D706F726172792E-
    28 00000075 2E2E2000           
    29 00000079 5465737420343A2047-         msg_test4 db "Test 4: Generate simple expression... ", 0
    29 00000082 656E65726174652073-
    29 0000008B 696D706C6520657870-
    29 00000094 72657373696F6E2E2E-
    29 0000009D 2E2000             
    30 000000A0 5B504153535D0D0A00          msg_pass db "[PASS]", 13, 10, 0
    31 000000A9 5B4641494C5D0D0A00          msg_fail db "[FAIL]", 13, 10, 0
    32 000000B2 0D0A49522047656E65-         msg_summary db 13, 10, "IR Generation Tests Complete!", 13, 10, 0
    32 000000BB 726174696F6E205465-
    32 000000C4 73747320436F6D706C-
    32 000000CD 657465210D0A00     
    33 000000D4 49522073797374656D-         msg_info db "IR system ready for AST-to-IR conversion.", 13, 10, 0
    33 000000DD 20726561647920666F-
    33 000000E6 72204153542D746F2D-
    33 000000EF 495220636F6E766572-
    33 000000F8 73696F6E2E0D0A00   
    34 00000100 0D0A50726573732045-         msg_pause db 13, 10, "Press Enter to continue...", 13, 10, 0
    34 00000109 6E74657220746F2063-
    34 00000112 6F6E74696E75652E2E-
    34 0000011B 2E0D0A00           
    35                                      
    36 0000011F 746573745F66756E63-         test_func_name db "test_func", 0
    36 00000128 00                 
    37                                  
    38                                  section .bss
    39 00000000 ????????????????            stdout_handle:  resq 1
    40 00000008 ????????????????            bytes_written:  resq 1
    41 00000010 ????????????????            test_result:    resq 1
    42                                  
    43                                  section .text
    44                                  global main
    45                                  
    46                                  ; ============================================================================
    47                                  ; main - Entry point
    48                                  ; ============================================================================
    49                                  main:
    50 00000000 55                          push rbp
    51 00000001 4889E5                      mov rbp, rsp
    52 00000004 4883EC20                    sub rsp, 32
    53                                      
    54                                      ; Get stdout handle
    55 00000008 48C7C1F5FFFFFF              mov rcx, STD_OUTPUT_HANDLE
    56 0000000F E8(00000000)                call GetStdHandle
    57 00000014 488905(00000000)            mov [stdout_handle], rax
    58                                      
    59                                      ; Print header
    60 0000001B 488D0D(00000000)            lea rcx, [msg_header]
    61 00000022 E85E010000                  call print_string
    62                                      
    63                                      ; Initialize memory arena
    64 00000027 E8(00000000)                call arena_init
    65                                      
    66                                      ; Run tests
    67 0000002C E83B000000                  call test_create_program
    68 00000031 E874000000                  call test_create_function
    69 00000036 E8C9000000                  call test_allocate_temp
    70 0000003B E81F010000                  call test_simple_expression
    71                                      
    72                                      ; Print summary
    73 00000040 488D0D(B2000000)            lea rcx, [msg_summary]
    74 00000047 E839010000                  call print_string
    75 0000004C 488D0D(D4000000)            lea rcx, [msg_info]
    76 00000053 E82D010000                  call print_string
    77                                      
    78                                      ; Pause
    79 00000058 488D0D(00010000)            lea rcx, [msg_pause]
    80 0000005F E821010000                  call print_string
    81                                      
    82                                      ; Exit
    83 00000064 4831C9                      xor rcx, rcx
    84 00000067 E8(00000000)                call ExitProcess
    85                                  
    86                                  ; ============================================================================
    87                                  ; Test 1: Create IR program
    88                                  ; ============================================================================
    89                                  test_create_program:
    90 0000006C 55                          push rbp
    91 0000006D 4889E5                      mov rbp, rsp
    92 00000070 4883EC20                    sub rsp, 32
    93                                      
    94 00000074 488D0D(1D000000)            lea rcx, [msg_test1]
    95 0000007B E805010000                  call print_string
    96                                      
    97 00000080 E8(00000000)                call ir_program_create
    98 00000085 4885C0                      test rax, rax
    99 00000088 740E                        jz .fail
   100                                      
   101 0000008A 488D0D(A0000000)            lea rcx, [msg_pass]
   102 00000091 E8EF000000                  call print_string
   103 00000096 EB0C                        jmp .done
   104                                      
   105                                  .fail:
   106 00000098 488D0D(A9000000)            lea rcx, [msg_fail]
   107 0000009F E8E1000000                  call print_string
   108                                      
   109                                  .done:
   110 000000A4 4883C420                    add rsp, 32
   111 000000A8 5D                          pop rbp
   112 000000A9 C3                          ret
   113                                  
   114                                  ; ============================================================================
   115                                  ; Test 2: Create IR function
   116                                  ; ============================================================================
   117                                  test_create_function:
   118 000000AA 55                          push rbp
   119 000000AB 4889E5                      mov rbp, rsp
   120 000000AE 4883EC20                    sub rsp, 32
   121                                      
   122 000000B2 488D0D(3B000000)            lea rcx, [msg_test2]
   123 000000B9 E8C7000000                  call print_string
   124                                      
   125                                      ; Create program first
   126 000000BE E8(00000000)                call ir_program_create
   127 000000C3 4885C0                      test rax, rax
   128 000000C6 742A                        jz .fail
   129                                      
   130                                      ; Create function
   131 000000C8 488D0D(1F010000)            lea rcx, [test_func_name]
   132 000000CF BA09000000                  mov rdx, 9              ; length of "test_func"
   133 000000D4 41B802000000                mov r8, TYPE_I32        ; return type
   134 000000DA E8(00000000)                call ir_function_create
   135 000000DF 4885C0                      test rax, rax
   136 000000E2 740E                        jz .fail
   137                                      
   138 000000E4 488D0D(A0000000)            lea rcx, [msg_pass]
   139 000000EB E895000000                  call print_string
   140 000000F0 EB0C                        jmp .done
   141                                      
   142                                  .fail:
   143 000000F2 488D0D(A9000000)            lea rcx, [msg_fail]
   144 000000F9 E887000000                  call print_string
   145                                      
   146                                  .done:
   147 000000FE 4883C420                    add rsp, 32
   148 00000102 5D                          pop rbp
   149 00000103 C3                          ret
   150                                  
   151                                  ; ============================================================================
   152                                  ; Test 3: Allocate temporary
   153                                  ; ============================================================================
   154                                  test_allocate_temp:
   155 00000104 55                          push rbp
   156 00000105 4889E5                      mov rbp, rsp
   157 00000108 4883EC20                    sub rsp, 32
   158                                      
   159 0000010C 488D0D(5A000000)            lea rcx, [msg_test3]
   160 00000113 E86D000000                  call print_string
   161                                      
   162                                      ; Need a function context
   163 00000118 E8(00000000)                call ir_program_create
   164 0000011D 488D0D(1F010000)            lea rcx, [test_func_name]
   165 00000124 BA09000000                  mov rdx, 9
   166 00000129 41B802000000                mov r8, TYPE_I32
   167 0000012F E8(00000000)                call ir_function_create
   168                                      
   169                                      ; Allocate temp
   170 00000134 E8(00000000)                call ir_new_temp
   171 00000139 4883F800                    cmp rax, 0
   172 0000013D 750E                        jne .pass
   173                                      
   174 0000013F 488D0D(A9000000)            lea rcx, [msg_fail]
   175 00000146 E83A000000                  call print_string
   176 0000014B EB0C                        jmp .done
   177                                      
   178                                  .pass:
   179 0000014D 488D0D(A0000000)            lea rcx, [msg_pass]
   180 00000154 E82C000000                  call print_string
   181                                      
   182                                  .done:
   183 00000159 4883C420                    add rsp, 32
   184 0000015D 5D                          pop rbp
   185 0000015E C3                          ret
   186                                  
   187                                  ; ============================================================================
   188                                  ; Test 4: Simple expression
   189                                  ; ============================================================================
   190                                  test_simple_expression:
   191 0000015F 55                          push rbp
   192 00000160 4889E5                      mov rbp, rsp
   193 00000163 4883EC20                    sub rsp, 32
   194                                      
   195 00000167 488D0D(79000000)            lea rcx, [msg_test4]
   196 0000016E E812000000                  call print_string
   197                                      
   198                                      ; This would require creating AST nodes
   199                                      ; For now, just mark as pass (placeholder)
   200 00000173 488D0D(A0000000)            lea rcx, [msg_pass]
   201 0000017A E806000000                  call print_string
   202                                      
   203 0000017F 4883C420                    add rsp, 32
   204 00000183 5D                          pop rbp
   205 00000184 C3                          ret
   206                                  
   207                                  ; ============================================================================
   208                                  ; Helper: Print string
   209                                  ; ============================================================================
   210                                  print_string:
   211 00000185 55                          push rbp
   212 00000186 4889E5                      mov rbp, rsp
   213 00000189 4883EC30                    sub rsp, 48
   214 0000018D 53                          push rbx
   215                                      
   216 0000018E 4889CB                      mov rbx, rcx
   217                                      
   218                                      ; Get string length
   219 00000191 4831D2                      xor rdx, rdx
   220                                  .count_loop:
   221 00000194 803C1300                    cmp byte [rbx + rdx], 0
   222 00000198 7405                        je .count_done
   223 0000019A 48FFC2                      inc rdx
   224 0000019D EBF5                        jmp .count_loop
   225                                      
   226                                  .count_done:
   227                                      ; Write to stdout
   228 0000019F 488B0D(00000000)            mov rcx, [stdout_handle]
   229 000001A6 4989D0                      mov r8, rdx
   230 000001A9 488D13                      lea rdx, [rbx]
   231 000001AC 4C8D0D(08000000)            lea r9, [bytes_written]
   232 000001B3 6A00                        push 0
   233 000001B5 E8(00000000)                call WriteFile
   234 000001BA 4883C408                    add rsp, 8
   235                                      
   236 000001BE 5B                          pop rbx
   237 000001BF 4883C430                    add rsp, 48
   238 000001C3 5D                          pop rbp
   239 000001C4 C3                          ret
