     1                                  ; ============================================================================
     2                                  ; Flash Compiler - Intermediate Representation (IR)
     3                                  ; ============================================================================
     4                                  ; Three-Address Code (TAC) IR for the Flash compiler
     5                                  ; Simple, optimizable, and easy to translate to machine code
     6                                  ; ============================================================================
     7                                  
     8                                  bits 64
     9                                  default rel
    10                                  
    11                                  ; ============================================================================
    12                                  ; IR Opcode Definitions
    13                                  ; ============================================================================
    14                                  
    15                                  ; Arithmetic operations (0-19)
    16                                  %define IR_ADD          0       ; dest = src1 + src2
    17                                  %define IR_SUB          1       ; dest = src1 - src2
    18                                  %define IR_MUL          2       ; dest = src1 * src2
    19                                  %define IR_DIV          3       ; dest = src1 / src2
    20                                  %define IR_MOD          4       ; dest = src1 % src2
    21                                  %define IR_NEG          5       ; dest = -src1
    22                                  
    23                                  ; Bitwise operations (20-29)
    24                                  %define IR_AND          20      ; dest = src1 & src2
    25                                  %define IR_OR           21      ; dest = src1 | src2
    26                                  %define IR_XOR          22      ; dest = src1 ^ src2
    27                                  %define IR_NOT          23      ; dest = ~src1
    28                                  %define IR_SHL          24      ; dest = src1 << src2
    29                                  %define IR_SHR          25      ; dest = src1 >> src2
    30                                  
    31                                  ; Comparison operations (30-39)
    32                                  %define IR_EQ           30      ; dest = src1 == src2
    33                                  %define IR_NE           31      ; dest = src1 != src2
    34                                  %define IR_LT           32      ; dest = src1 < src2
    35                                  %define IR_LE           33      ; dest = src1 <= src2
    36                                  %define IR_GT           34      ; dest = src1 > src2
    37                                  %define IR_GE           35      ; dest = src1 >= src2
    38                                  
    39                                  ; Memory operations (40-49)
    40                                  %define IR_MOVE         40      ; dest = src1 (copy)
    41                                  %define IR_LOAD         41      ; dest = *src1 (load from memory)
    42                                  %define IR_STORE        42      ; *dest = src1 (store to memory)
    43                                  %define IR_ADDR         43      ; dest = &src1 (address of)
    44                                  %define IR_ALLOC        44      ; dest = alloc(size)
    45                                  
    46                                  ; Control flow (50-69)
    47                                  %define IR_LABEL        50      ; label:
    48                                  %define IR_JUMP         51      ; goto label
    49                                  %define IR_JUMP_IF      52      ; if src1 goto label
    50                                  %define IR_JUMP_IF_NOT  53      ; if !src1 goto label
    51                                  %define IR_CALL         54      ; dest = call func(args...)
    52                                  %define IR_RETURN       55      ; return src1
    53                                  %define IR_RETURN_VOID  56      ; return (void)
    54                                  %define IR_PARAM        57      ; param src1 (pass parameter)
    55                                  
    56                                  ; Type conversions (70-79)
    57                                  %define IR_CAST         70      ; dest = (type)src1
    58                                  %define IR_ZEXT         71      ; dest = zero_extend(src1)
    59                                  %define IR_SEXT         72      ; dest = sign_extend(src1)
    60                                  %define IR_TRUNC        73      ; dest = truncate(src1)
    61                                  
    62                                  ; Array/struct operations (80-89)
    63                                  %define IR_INDEX        80      ; dest = src1[src2]
    64                                  %define IR_FIELD        81      ; dest = src1.field
    65                                  %define IR_ARRAY_ALLOC  82      ; dest = alloc_array(count, elem_size)
    66                                  
    67                                  ; Special (90-99)
    68                                  %define IR_NOP          90      ; no operation
    69                                  %define IR_PHI          91      ; dest = phi(src1, src2, ...) for SSA
    70                                  
    71                                  ; ============================================================================
    72                                  ; IR Operand Types
    73                                  ; ============================================================================
    74                                  %define IR_OP_TEMP      0       ; Temporary (virtual register)
    75                                  %define IR_OP_VAR       1       ; Variable (named)
    76                                  %define IR_OP_CONST     2       ; Constant (immediate)
    77                                  %define IR_OP_LABEL     3       ; Label (for jumps)
    78                                  %define IR_OP_FUNC      4       ; Function name
    79                                  %define IR_OP_NONE      5       ; No operand
    80                                  
    81                                  ; ============================================================================
    82                                  ; IR Operand Structure
    83                                  ; ============================================================================
    84                                  struc IROperand
    85 00000000 ????????????????            .type:          resq 1      ; Operand type (IR_OP_TEMP, etc.)
    86 00000008 ????????????????            .value:         resq 1      ; Value (temp number, var name, constant, label)
    87 00000010 ????????????????            .data_type:     resq 1      ; Data type (TYPE_I32, etc.)
    88 00000018 ????????????????            .aux:           resq 1      ; Auxiliary data (string length for vars, etc.)
    89                                  endstruc
    90                                  
    91                                  ; ============================================================================
    92                                  ; IR Instruction Structure
    93                                  ; ============================================================================
    94                                  struc IRInstruction
    95 00000000 ????????????????            .opcode:        resq 1      ; IR opcode
    96 00000008 <res 20h>                   .dest:          resb IROperand_size     ; Destination operand
    97 00000028 <res 20h>                   .src1:          resb IROperand_size     ; Source operand 1
    98 00000048 <res 20h>                   .src2:          resb IROperand_size     ; Source operand 2
    99 00000068 ????????????????            .line:          resq 1      ; Source line number
   100 00000070 ????????????????            .next:          resq 1      ; Next instruction in list
   101                                  endstruc
   102                                  
   103                                  ; ============================================================================
   104                                  ; IR Function Structure
   105                                  ; ============================================================================
   106                                  struc IRFunction
   107 00000000 ????????????????            .name:          resq 1      ; Function name
   108 00000008 ????????????????            .name_len:      resq 1      ; Name length
   109 00000010 ????????????????            .params:        resq 1      ; Array of IROperand (parameters)
   110 00000018 ????????????????            .param_count:   resq 1      ; Number of parameters
   111 00000020 ????????????????            .return_type:   resq 1      ; Return type
   112 00000028 ????????????????            .instructions:  resq 1      ; First instruction
   113 00000030 ????????????????            .last_inst:     resq 1      ; Last instruction (for easy append)
   114 00000038 ????????????????            .temp_count:    resq 1      ; Number of temporaries used
   115 00000040 ????????????????            .label_count:   resq 1      ; Number of labels used
   116 00000048 ????????????????            .next:          resq 1      ; Next function in program
   117                                  endstruc
   118                                  
   119                                  ; ============================================================================
   120                                  ; IR Program Structure
   121                                  ; ============================================================================
   122                                  struc IRProgram
   123 00000000 ????????????????            .functions:     resq 1      ; First function
   124 00000008 ????????????????            .last_func:     resq 1      ; Last function (for easy append)
   125 00000010 ????????????????            .func_count:    resq 1      ; Number of functions
   126 00000018 ????????????????            .global_vars:   resq 1      ; Global variables list
   127                                  endstruc
   128                                  
   129                                  ; ============================================================================
   130                                  ; Data Section
   131                                  ; ============================================================================
   132                                  section .bss
   133 00000000 ????????????????            current_ir_func:    resq 1      ; Current function being generated
   134 00000008 ????????????????            current_program:    resq 1      ; Current IR program
   135                                  
   136                                  section .text
   137                                  
   138                                  global ir_program_create
   139                                  global ir_function_create
   140                                  global ir_instruction_create
   141                                  global ir_operand_temp
   142                                  global ir_operand_var
   143                                  global ir_operand_const
   144                                  global ir_operand_label
   145                                  global ir_emit
   146                                  global ir_emit_label
   147                                  global ir_emit_binary
   148                                  global ir_emit_unary
   149                                  global ir_emit_move
   150                                  global ir_emit_jump
   151                                  global ir_emit_jump_if
   152                                  global ir_emit_call
   153                                  global ir_emit_return
   154                                  global ir_new_temp
   155                                  global ir_new_label
   156                                  
   157                                  extern arena_alloc
   158                                  
   159                                  ; ============================================================================
   160                                  ; ir_program_create - Create new IR program
   161                                  ; Returns:
   162                                  ;   RAX = pointer to IRProgram
   163                                  ; ============================================================================
   164                                  ir_program_create:
   165 00000000 55                          push rbp
   166 00000001 4889E5                      mov rbp, rsp
   167 00000004 4883EC20                    sub rsp, 32
   168                                      
   169 00000008 B920000000                  mov rcx, IRProgram_size
   170 0000000D E8(00000000)                call arena_alloc
   171 00000012 4885C0                      test rax, rax
   172 00000015 7426                        jz .error
   173                                      
   174                                      ; Initialize program
   175 00000017 48C70000000000              mov qword [rax + IRProgram.functions], 0
   176 0000001E 48C7400800000000            mov qword [rax + IRProgram.last_func], 0
   177 00000026 48C7401000000000            mov qword [rax + IRProgram.func_count], 0
   178 0000002E 48C7401800000000            mov qword [rax + IRProgram.global_vars], 0
   179                                      
   180 00000036 488905(08000000)            mov [current_program], rax
   181                                      
   182                                  .error:
   183 0000003D 4883C420                    add rsp, 32
   184 00000041 5D                          pop rbp
   185 00000042 C3                          ret
   186                                  
   187                                  ; ============================================================================
   188                                  ; ir_function_create - Create new IR function
   189                                  ; Parameters:
   190                                  ;   RCX = function name pointer
   191                                  ;   RDX = function name length
   192                                  ;   R8  = return type
   193                                  ; Returns:
   194                                  ;   RAX = pointer to IRFunction
   195                                  ; ============================================================================
   196                                  ir_function_create:
   197 00000043 55                          push rbp
   198 00000044 4889E5                      mov rbp, rsp
   199 00000047 4883EC30                    sub rsp, 48
   200 0000004B 53                          push rbx
   201 0000004C 4154                        push r12
   202 0000004E 4155                        push r13
   203                                      
   204 00000050 4889CB                      mov rbx, rcx    ; name
   205 00000053 4989D4                      mov r12, rdx    ; name_len
   206 00000056 4D89C5                      mov r13, r8     ; return_type
   207                                      
   208 00000059 B950000000                  mov rcx, IRFunction_size
   209 0000005E E8(00000000)                call arena_alloc
   210 00000063 4885C0                      test rax, rax
   211 00000066 7474                        jz .error
   212                                      
   213                                      ; Initialize function
   214 00000068 488918                      mov [rax + IRFunction.name], rbx
   215 0000006B 4C896008                    mov [rax + IRFunction.name_len], r12
   216 0000006F 48C7401000000000            mov qword [rax + IRFunction.params], 0
   217 00000077 48C7401800000000            mov qword [rax + IRFunction.param_count], 0
   218 0000007F 4C896820                    mov [rax + IRFunction.return_type], r13
   219 00000083 48C7402800000000            mov qword [rax + IRFunction.instructions], 0
   220 0000008B 48C7403000000000            mov qword [rax + IRFunction.last_inst], 0
   221 00000093 48C7403800000000            mov qword [rax + IRFunction.temp_count], 0
   222 0000009B 48C7404000000000            mov qword [rax + IRFunction.label_count], 0
   223 000000A3 48C7404800000000            mov qword [rax + IRFunction.next], 0
   224                                      
   225                                      ; Add to program if one exists
   226 000000AB 488B0D(08000000)            mov rcx, [current_program]
   227 000000B2 4885C9                      test rcx, rcx
   228 000000B5 741E                        jz .no_program
   229                                      
   230                                      ; Append to program's function list
   231 000000B7 488B5108                    mov rdx, [rcx + IRProgram.last_func]
   232 000000BB 4885D2                      test rdx, rdx
   233 000000BE 740A                        jz .first_func
   234                                      
   235                                      ; Add after last function
   236 000000C0 48894248                    mov [rdx + IRFunction.next], rax
   237 000000C4 48894108                    mov [rcx + IRProgram.last_func], rax
   238 000000C8 EB07                        jmp .update_count
   239                                      
   240                                  .first_func:
   241 000000CA 488901                      mov [rcx + IRProgram.functions], rax
   242 000000CD 48894108                    mov [rcx + IRProgram.last_func], rax
   243                                      
   244                                  .update_count:
   245 000000D1 48FF4110                    inc qword [rcx + IRProgram.func_count]
   246                                      
   247                                  .no_program:
   248 000000D5 488905(00000000)            mov [current_ir_func], rax
   249                                      
   250                                  .error:
   251 000000DC 415D                        pop r13
   252 000000DE 415C                        pop r12
   253 000000E0 5B                          pop rbx
   254 000000E1 4883C430                    add rsp, 48
   255 000000E5 5D                          pop rbp
   256 000000E6 C3                          ret
   257                                  
   258                                  ; ============================================================================
   259                                  ; ir_instruction_create - Create new IR instruction
   260                                  ; Parameters:
   261                                  ;   RCX = opcode
   262                                  ; Returns:
   263                                  ;   RAX = pointer to IRInstruction
   264                                  ; ============================================================================
   265                                  ir_instruction_create:
   266 000000E7 55                          push rbp
   267 000000E8 4889E5                      mov rbp, rsp
   268 000000EB 4883EC20                    sub rsp, 32
   269 000000EF 53                          push rbx
   270                                      
   271 000000F0 4889CB                      mov rbx, rcx    ; opcode
   272                                      
   273 000000F3 B978000000                  mov rcx, IRInstruction_size
   274 000000F8 E8(00000000)                call arena_alloc
   275 000000FD 4885C0                      test rax, rax
   276 00000100 7434                        jz .error
   277                                      
   278                                      ; Initialize instruction
   279 00000102 488918                      mov [rax + IRInstruction.opcode], rbx
   280 00000105 48C7406800000000            mov qword [rax + IRInstruction.line], 0
   281 0000010D 48C7407000000000            mov qword [rax + IRInstruction.next], 0
   282                                      
   283                                      ; Initialize operands to NONE
   284 00000115 488D4808                    lea rcx, [rax + IRInstruction.dest]
   285 00000119 48C70105000000              mov qword [rcx + IROperand.type], IR_OP_NONE
   286                                      
   287 00000120 488D4828                    lea rcx, [rax + IRInstruction.src1]
   288 00000124 48C70105000000              mov qword [rcx + IROperand.type], IR_OP_NONE
   289                                      
   290 0000012B 488D4848                    lea rcx, [rax + IRInstruction.src2]
   291 0000012F 48C70105000000              mov qword [rcx + IROperand.type], IR_OP_NONE
   292                                      
   293                                  .error:
   294 00000136 5B                          pop rbx
   295 00000137 4883C420                    add rsp, 32
   296 0000013B 5D                          pop rbp
   297 0000013C C3                          ret
   298                                  
   299                                  ; ============================================================================
   300                                  ; ir_operand_temp - Create temporary operand
   301                                  ; Parameters:
   302                                  ;   RCX = pointer to operand structure
   303                                  ;   RDX = temp number
   304                                  ;   R8  = data type
   305                                  ; ============================================================================
   306                                  ir_operand_temp:
   307 0000013D 55                          push rbp
   308 0000013E 4889E5                      mov rbp, rsp
   309                                      
   310 00000141 48C70100000000              mov qword [rcx + IROperand.type], IR_OP_TEMP
   311 00000148 48895108                    mov [rcx + IROperand.value], rdx
   312 0000014C 4C894110                    mov [rcx + IROperand.data_type], r8
   313 00000150 48C7411800000000            mov qword [rcx + IROperand.aux], 0
   314                                      
   315 00000158 5D                          pop rbp
   316 00000159 C3                          ret
   317                                  
   318                                  ; ============================================================================
   319                                  ; ir_operand_var - Create variable operand
   320                                  ; Parameters:
   321                                  ;   RCX = pointer to operand structure
   322                                  ;   RDX = variable name pointer
   323                                  ;   R8  = variable name length
   324                                  ;   R9  = data type
   325                                  ; ============================================================================
   326                                  ir_operand_var:
   327 0000015A 55                          push rbp
   328 0000015B 4889E5                      mov rbp, rsp
   329                                      
   330 0000015E 48C70101000000              mov qword [rcx + IROperand.type], IR_OP_VAR
   331 00000165 48895108                    mov [rcx + IROperand.value], rdx
   332 00000169 4C894118                    mov [rcx + IROperand.aux], r8
   333 0000016D 4C894910                    mov [rcx + IROperand.data_type], r9
   334                                      
   335 00000171 5D                          pop rbp
   336 00000172 C3                          ret
   337                                  
   338                                  ; ============================================================================
   339                                  ; ir_operand_const - Create constant operand
   340                                  ; Parameters:
   341                                  ;   RCX = pointer to operand structure
   342                                  ;   RDX = constant value
   343                                  ;   R8  = data type
   344                                  ; ============================================================================
   345                                  ir_operand_const:
   346 00000173 55                          push rbp
   347 00000174 4889E5                      mov rbp, rsp
   348                                      
   349 00000177 48C70102000000              mov qword [rcx + IROperand.type], IR_OP_CONST
   350 0000017E 48895108                    mov [rcx + IROperand.value], rdx
   351 00000182 4C894110                    mov [rcx + IROperand.data_type], r8
   352 00000186 48C7411800000000            mov qword [rcx + IROperand.aux], 0
   353                                      
   354 0000018E 5D                          pop rbp
   355 0000018F C3                          ret
   356                                  
   357                                  ; ============================================================================
   358                                  ; ir_operand_label - Create label operand
   359                                  ; Parameters:
   360                                  ;   RCX = pointer to operand structure
   361                                  ;   RDX = label number
   362                                  ; ============================================================================
   363                                  ir_operand_label:
   364 00000190 55                          push rbp
   365 00000191 4889E5                      mov rbp, rsp
   366                                      
   367 00000194 48C70103000000              mov qword [rcx + IROperand.type], IR_OP_LABEL
   368 0000019B 48895108                    mov [rcx + IROperand.value], rdx
   369 0000019F 48C7411000000000            mov qword [rcx + IROperand.data_type], 0
   370 000001A7 48C7411800000000            mov qword [rcx + IROperand.aux], 0
   371                                      
   372 000001AF 5D                          pop rbp
   373 000001B0 C3                          ret
   374                                  
   375                                  ; ============================================================================
   376                                  ; ir_emit - Emit instruction to current function
   377                                  ; Parameters:
   378                                  ;   RCX = pointer to IRInstruction
   379                                  ; ============================================================================
   380                                  ir_emit:
   381 000001B1 55                          push rbp
   382 000001B2 4889E5                      mov rbp, rsp
   383 000001B5 53                          push rbx
   384                                      
   385 000001B6 4889CB                      mov rbx, rcx    ; instruction
   386 000001B9 488B0D(00000000)            mov rcx, [current_ir_func]
   387 000001C0 4885C9                      test rcx, rcx
   388 000001C3 741B                        jz .no_function
   389                                      
   390                                      ; Get last instruction
   391 000001C5 488B5130                    mov rdx, [rcx + IRFunction.last_inst]
   392 000001C9 4885D2                      test rdx, rdx
   393 000001CC 740A                        jz .first_inst
   394                                      
   395                                      ; Append after last
   396 000001CE 48895A70                    mov [rdx + IRInstruction.next], rbx
   397 000001D2 48895930                    mov [rcx + IRFunction.last_inst], rbx
   398 000001D6 EB08                        jmp .done
   399                                      
   400                                  .first_inst:
   401 000001D8 48895928                    mov [rcx + IRFunction.instructions], rbx
   402 000001DC 48895930                    mov [rcx + IRFunction.last_inst], rbx
   403                                      
   404                                  .done:
   405                                  .no_function:
   406 000001E0 5B                          pop rbx
   407 000001E1 5D                          pop rbp
   408 000001E2 C3                          ret
   409                                  
   410                                  ; ============================================================================
   411                                  ; ir_new_temp - Allocate new temporary register
   412                                  ; Returns:
   413                                  ;   RAX = temporary number
   414                                  ; ============================================================================
   415                                  ir_new_temp:
   416 000001E3 55                          push rbp
   417 000001E4 4889E5                      mov rbp, rsp
   418                                      
   419 000001E7 488B05(00000000)            mov rax, [current_ir_func]
   420 000001EE 4885C0                      test rax, rax
   421 000001F1 7417                        jz .error
   422                                      
   423 000001F3 488B4838                    mov rcx, [rax + IRFunction.temp_count]
   424 000001F7 4889C8                      mov rax, rcx
   425 000001FA 48FFC1                      inc rcx
   426 000001FD 488B15(00000000)            mov rdx, [current_ir_func]
   427 00000204 48894A38                    mov [rdx + IRFunction.temp_count], rcx
   428 00000208 EB03                        jmp .done
   429                                      
   430                                  .error:
   431 0000020A 4831C0                      xor rax, rax
   432                                      
   433                                  .done:
   434 0000020D 5D                          pop rbp
   435 0000020E C3                          ret
   436                                  
   437                                  ; ============================================================================
   438                                  ; ir_new_label - Allocate new label number
   439                                  ; Returns:
   440                                  ;   RAX = label number
   441                                  ; ============================================================================
   442                                  ir_new_label:
   443 0000020F 55                          push rbp
   444 00000210 4889E5                      mov rbp, rsp
   445                                      
   446 00000213 488B05(00000000)            mov rax, [current_ir_func]
   447 0000021A 4885C0                      test rax, rax
   448 0000021D 7417                        jz .error
   449                                      
   450 0000021F 488B4840                    mov rcx, [rax + IRFunction.label_count]
   451 00000223 4889C8                      mov rax, rcx
   452 00000226 48FFC1                      inc rcx
   453 00000229 488B15(00000000)            mov rdx, [current_ir_func]
   454 00000230 48894A40                    mov [rdx + IRFunction.label_count], rcx
   455 00000234 EB03                        jmp .done
   456                                      
   457                                  .error:
   458 00000236 4831C0                      xor rax, rax
   459                                      
   460                                  .done:
   461 00000239 5D                          pop rbp
   462 0000023A C3                          ret
   463                                  
   464                                  ; ============================================================================
   465                                  ; ir_emit_binary - Emit binary operation instruction
   466                                  ; Parameters:
   467                                  ;   RCX = opcode
   468                                  ;   RDX = dest operand ptr
   469                                  ;   R8  = src1 operand ptr
   470                                  ;   R9  = src2 operand ptr
   471                                  ; Returns:
   472                                  ;   RAX = pointer to created instruction
   473                                  ; ============================================================================
   474                                  ir_emit_binary:
   475 0000023B 55                          push rbp
   476 0000023C 4889E5                      mov rbp, rsp
   477 0000023F 4883EC40                    sub rsp, 64
   478 00000243 53                          push rbx
   479 00000244 4154                        push r12
   480 00000246 4155                        push r13
   481 00000248 4156                        push r14
   482                                      
   483 0000024A 4889CB                      mov rbx, rcx    ; opcode
   484 0000024D 4989D4                      mov r12, rdx    ; dest
   485 00000250 4D89C5                      mov r13, r8     ; src1
   486 00000253 4D89CE                      mov r14, r9     ; src2
   487                                      
   488                                      ; Create instruction
   489 00000256 4889D9                      mov rcx, rbx
   490 00000259 E889FEFFFF                  call ir_instruction_create
   491 0000025E 4885C0                      test rax, rax
   492 00000261 7445                        jz .error
   493                                      
   494 00000263 50                          push rax
   495                                      
   496                                      ; Copy operands
   497 00000264 488D4808                    lea rcx, [rax + IRInstruction.dest]
   498 00000268 4C89E6                      mov rsi, r12
   499 0000026B 4889CF                      mov rdi, rcx
   500 0000026E B920000000                  mov rcx, IROperand_size
   501 00000273 F3A4                        rep movsb
   502                                      
   503 00000275 58                          pop rax
   504 00000276 50                          push rax
   505                                      
   506 00000277 488D4828                    lea rcx, [rax + IRInstruction.src1]
   507 0000027B 4C89EE                      mov rsi, r13
   508 0000027E 4889CF                      mov rdi, rcx
   509 00000281 B920000000                  mov rcx, IROperand_size
   510 00000286 F3A4                        rep movsb
   511                                      
   512 00000288 58                          pop rax
   513 00000289 50                          push rax
   514                                      
   515 0000028A 488D4848                    lea rcx, [rax + IRInstruction.src2]
   516 0000028E 4C89F6                      mov rsi, r14
   517 00000291 4889CF                      mov rdi, rcx
   518 00000294 B920000000                  mov rcx, IROperand_size
   519 00000299 F3A4                        rep movsb
   520                                      
   521 0000029B 58                          pop rax
   522 0000029C 50                          push rax
   523                                      
   524                                      ; Emit instruction
   525 0000029D 4889C1                      mov rcx, rax
   526 000002A0 E80CFFFFFF                  call ir_emit
   527                                      
   528 000002A5 58                          pop rax
   529 000002A6 EB03                        jmp .done
   530                                      
   531                                  .error:
   532 000002A8 4831C0                      xor rax, rax
   533                                      
   534                                  .done:
   535 000002AB 415E                        pop r14
   536 000002AD 415D                        pop r13
   537 000002AF 415C                        pop r12
   538 000002B1 5B                          pop rbx
   539 000002B2 4883C440                    add rsp, 64
   540 000002B6 5D                          pop rbp
   541 000002B7 C3                          ret
   542                                  
   543                                  ; ============================================================================
   544                                  ; ir_emit_move - Emit move instruction
   545                                  ; Parameters:
   546                                  ;   RCX = dest operand ptr
   547                                  ;   RDX = src operand ptr
   548                                  ; Returns:
   549                                  ;   RAX = pointer to created instruction
   550                                  ; ============================================================================
   551                                  ir_emit_move:
   552 000002B8 55                          push rbp
   553 000002B9 4889E5                      mov rbp, rsp
   554 000002BC 4883EC30                    sub rsp, 48
   555 000002C0 53                          push rbx
   556 000002C1 4154                        push r12
   557                                      
   558 000002C3 4889CB                      mov rbx, rcx    ; dest
   559 000002C6 4989D4                      mov r12, rdx    ; src
   560                                      
   561 000002C9 B928000000                  mov rcx, IR_MOVE
   562 000002CE E814FEFFFF                  call ir_instruction_create
   563 000002D3 4885C0                      test rax, rax
   564 000002D6 7432                        jz .error
   565                                      
   566 000002D8 50                          push rax
   567                                      
   568                                      ; Copy dest
   569 000002D9 488D4808                    lea rcx, [rax + IRInstruction.dest]
   570 000002DD 4889DE                      mov rsi, rbx
   571 000002E0 4889CF                      mov rdi, rcx
   572 000002E3 B920000000                  mov rcx, IROperand_size
   573 000002E8 F3A4                        rep movsb
   574                                      
   575 000002EA 58                          pop rax
   576 000002EB 50                          push rax
   577                                      
   578                                      ; Copy src1
   579 000002EC 488D4828                    lea rcx, [rax + IRInstruction.src1]
   580 000002F0 4C89E6                      mov rsi, r12
   581 000002F3 4889CF                      mov rdi, rcx
   582 000002F6 B920000000                  mov rcx, IROperand_size
   583 000002FB F3A4                        rep movsb
   584                                      
   585 000002FD 58                          pop rax
   586 000002FE 50                          push rax
   587                                      
   588                                      ; Emit
   589 000002FF 4889C1                      mov rcx, rax
   590 00000302 E8AAFEFFFF                  call ir_emit
   591                                      
   592 00000307 58                          pop rax
   593 00000308 EB03                        jmp .done
   594                                      
   595                                  .error:
   596 0000030A 4831C0                      xor rax, rax
   597                                      
   598                                  .done:
   599 0000030D 415C                        pop r12
   600 0000030F 5B                          pop rbx
   601 00000310 4883C430                    add rsp, 48
   602 00000314 5D                          pop rbp
   603 00000315 C3                          ret
   604                                  
   605                                  ; ============================================================================
   606                                  ; ir_emit_return - Emit return instruction
   607                                  ; Parameters:
   608                                  ;   RCX = src operand ptr (or 0 for void return)
   609                                  ; Returns:
   610                                  ;   RAX = pointer to created instruction
   611                                  ; ============================================================================
   612                                  ir_emit_return:
   613 00000316 55                          push rbp
   614 00000317 4889E5                      mov rbp, rsp
   615 0000031A 4883EC20                    sub rsp, 32
   616 0000031E 53                          push rbx
   617                                      
   618 0000031F 4889CB                      mov rbx, rcx    ; src operand
   619                                      
   620                                      ; Choose opcode based on whether we have a value
   621 00000322 4885DB                      test rbx, rbx
   622 00000325 7407                        jz .void_return
   623                                      
   624 00000327 B937000000                  mov rcx, IR_RETURN
   625 0000032C EB05                        jmp .create
   626                                      
   627                                  .void_return:
   628 0000032E B938000000                  mov rcx, IR_RETURN_VOID
   629                                      
   630                                  .create:
   631 00000333 E8AFFDFFFF                  call ir_instruction_create
   632 00000338 4885C0                      test rax, rax
   633 0000033B 7424                        jz .error
   634                                      
   635                                      ; Copy src operand if provided
   636 0000033D 4885DB                      test rbx, rbx
   637 00000340 7413                        jz .no_src
   638                                      
   639 00000342 50                          push rax
   640 00000343 488D4828                    lea rcx, [rax + IRInstruction.src1]
   641 00000347 4889DE                      mov rsi, rbx
   642 0000034A 4889CF                      mov rdi, rcx
   643 0000034D B920000000                  mov rcx, IROperand_size
   644 00000352 F3A4                        rep movsb
   645 00000354 58                          pop rax
   646                                      
   647                                  .no_src:
   648 00000355 50                          push rax
   649 00000356 4889C1                      mov rcx, rax
   650 00000359 E853FEFFFF                  call ir_emit
   651 0000035E 58                          pop rax
   652 0000035F EB03                        jmp .done
   653                                      
   654                                  .error:
   655 00000361 4831C0                      xor rax, rax
   656                                      
   657                                  .done:
   658 00000364 5B                          pop rbx
   659 00000365 4883C420                    add rsp, 32
   660 00000369 5D                          pop rbp
   661 0000036A C3                          ret
