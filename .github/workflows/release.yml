name: Build Release

on:
  push:
    tags:
      - 'v*'

jobs:
  build-windows:
    runs-on: windows-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Install NASM
        run: |
          choco install nasm -y
          nasm -version
      
      - name: Build release
        run: |
          cd ${{ github.workspace }}
          nmake release
      
      - name: Extract version from tag
        id: version
        run: |
          $tag = "${{ github.ref }}"
          $version = $tag -replace 'refs/tags/v', ''
          Write-Output "VERSION=$version" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append
      
      - name: Rename artifact
        run: |
          $oldPath = "${{ github.workspace }}\dist\flash-v${{ steps.version.outputs.VERSION }}-windows-x64.zip"
          $newPath = "${{ github.workspace }}\dist\flash-${{ steps.version.outputs.VERSION }}-windows-x64.zip"
          if (Test-Path $oldPath) {
            Rename-Item -Path $oldPath -NewName (Split-Path $newPath -Leaf)
          }
      
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            ${{ github.workspace }}/dist/flash-${{ steps.version.outputs.VERSION }}-windows-x64.zip
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Upload to Release Assets
        uses: shogo82148/actions-upload-release-asset@v1
        with:
          upload_url: ${{ github.event.release.upload_url }}
          asset_path: ${{ github.workspace }}/dist/flash-*.zip
        if: ${{ github.event_name == 'release' }}
